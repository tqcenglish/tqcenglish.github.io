<!DOCTYPE html>
<html lang=zh-CN>
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="伐木掎矣，析薪杝矣">
  <meta name="keywords" content="">
  
    <link rel="icon" href="https://assets-cdn.github.com/favicon.ico">
  
    
  <title>Getting+Started+with+ARI | 羚羊挂角</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/lib/jquery.fancybox.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <!-- Global Site Tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=GA_TRACKING_ID"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-47275396-1');
  </script>
</head>

<body>
  <header>
  <div class="header-container">
    <a class='logo' href="/">
      <span>羚羊挂角</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id='post'>
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>Getting+Started+with+ARI</h1>
          <div class='post-meta'>
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2015年03月10日</time>
            
              | <i class="fa fa-folder-open-o" aria-hidden="true"></i> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/工作/">工作</a>
  </div>



            
            
          </div>
          <p><a href="https://wiki.asterisk.org/wiki/display/AST/Getting+Started+with+ARI" target="_blank" rel="noopener">原文链接</a></p>
<p>##概述<br>Asterisk 12 中介绍了Asterisk REST Interface, 一个构建Asterisk基本应用的RESTful应用接口集合。这篇文章会指导你开启ARI功能并运行一个基本的应用。</p>
<p>构建一个ARI应用包括如下三个主要的组件。</p>
<p>首先是这个RESTful应用接口本身。这个应用接口是通过<a href="http://swagger.io/" target="_blank" rel="noopener">Swagger</a>(一个轻量级的RESTful应用接口文档规格标准)生成.<a href="http://swagger.io/" target="_blank" rel="noopener">Swagger</a>应用接口文档被用于Asterisk本身生成有效的模板文件,静态的wiki文件和通过<a href="https://github.com/swagger-api/swagger-ui" target="_blank" rel="noopener">Swagger-UI</a>生成交互式文档.</p>
<p>其次，Asterisk需要发送异步事件到应用(建立新通道，通道桥接，通道挂断).这些通过基于<strong>/ari/events</strong>上的WebSocket实现.事件会作为JSON格式的消息发送，更多可以查看文档<a href="https://wiki.asterisk.org/wiki/display/AST/Asterisk+12+REST+Data+Models" target="_blank" rel="noopener">REST消息模型</a>(在列表中查看子标题<a href="https://wiki.asterisk.org/wiki/display/AST/Asterisk+12+REST+Data+Models#Asterisk12RESTDataModels-Message" target="_blank" rel="noopener"> Message data model</a>)</p>
<p>最后，连接这个拨号规则到你的应用<a href="https://wiki.asterisk.org/wiki/display/AST/Asterisk+12+Application_Stasis" target="_blank" rel="noopener">Stasis() dialplan application</a>.<br>在拨号规则内，你可以发送一个通道到Stasis(),为扩展的应用指定名称，以及发送可选参数到应用。</p>
<p>##例子 ARI Hello World!<br>在这个例子中，完成以下任务:</p>
<ul>
<li>配置Asterisk去开启ARI功能</li>
<li>发送一个通道到Stasis</li>
<li>在指定通道播放”Hello World”</li>
</ul>
<p>这个例子不会包括的内容:</p>
<ul>
<li>安装Asterisk,假设已经安装了Asterisk 12或最新版本并且已运行.</li>
<li>在Asterisk中配置SIP。为了实现这个例子的目的，我们假设你已经有软电话或硬电话并通过chan_sip或chan_pjsip注册到Asterisk.</li>
</ul>
<p>###安装wscat<br>ARI需要一个WebSocket连接去接收事件,为了实现这个例子的目的。我们使用wscat,一个非常便利的类似netcat基于Node.js的WebSocket 库的命令行工具。<br>如果没有安装wscat:</p>
<ol>
<li><p>如何还没有安装,首先安装npm</p>
<p>   apt-get install npm</p>
</li>
<li><p>安装ws包</p>
<p>   npm install -g wscat</p>
</li>
</ol>
<p>###安装 curl<br>  为了通过ARI控制Stasis拨号应用中的通道，我们需要一个Http 客户端。 根据这个例子的目的，我们使用 curl:</p>
<pre><code>apt-get install curl
</code></pre><p>###配置Asterisk</p>
<ol>
<li><p>在http.conf开启Asterisk的http服务.</p>
<p>   [general]<br>   enable = yes<br>   bindaddr = 0.0.0.0</p>
</li>
<li><p>在ari.conf中配置ARI用户</p>
<p>   [general]<br>   enable = yes<br>   pretty = yes</p>
<p>   [asterisk]<br>   type = user<br>   read_only = no<br>   password = asterisk</p>
</li>
<li><p>为Stasis应用创建拨号规则，这里，我们选择分机号1000在default的上下文中。如果你的SIP电话已经配置在不同的上下文中，需要相应的调整。</p>
<p>   [default]<br>   exten =&gt; 1000, 1, NoOp()<br>   same =&gt; n, Answer()<br>   same =&gt; n, Stasis(hello-world)<br>   same =&gt; n, Hangup()</p>
</li>
</ol>
<h3 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World!"></a>Hello World!</h3><ol>
<li><p>使用wscat连接到Asterisk</p>
<p>   wscat -c “ws://localhost:8088/ari/events?api_key=asterisk:asterisk&amp;app=hello-world”<br>   connected (press CTRL+C to quit)</p>
<p>在Asterisk中,我们应该看见一个新的WebSocket连接和一个我们Stasis应用被创建的消息</p>
<p>   == WebSocket connection from ‘127.0.0.1:37872’ for protocol ‘’ accepted using version ‘13’<br>   Creating Stasis app ‘hello-world’</p>
</li>
<li><p>在你的SIP设备上，拨打分机号1000</p>
<p>   – Executing [1000@default:1] NoOp(“PJSIP/1000-00000001”, “”) in new stack<br>   – Executing [1000@default:2] Answer(“PJSIP/1000-00000001”, “”) in new stack<br>   – PJSIP/1000-00000001 answered<br>   – Executing [1000@default:3] Stasis(“PJSIP/1000-00000001”, “hello-world”) in new stack</p>
<p>在wscat中,我们应该看见StasisStart事件，表明一个通道有进入我们的Stasis应用</p>
</li>
</ol>
<pre><code>{
 &quot;application&quot;:&quot;hello-world&quot;,
 &quot;type&quot;:&quot;StasisStart&quot;,
 &quot;timestamp&quot;:&quot;2014-05-20T13:15:27.131-0500&quot;,
 &quot;args&quot;:[],
 &quot;channel&quot;:{
    &quot;id&quot;:&quot;1400609726.3&quot;,
    &quot;state&quot;:&quot;Up&quot;,
    &quot;name&quot;:&quot;PJSIP/1000-00000001&quot;,
    &quot;caller&quot;:{
       &quot;name&quot;:&quot;&quot;,
       &quot;number&quot;:&quot;&quot;},
    &quot;connected&quot;:{
       &quot;name&quot;:&quot;&quot;,
       &quot;number&quot;:&quot;&quot;},
    &quot;accountcode&quot;:&quot;&quot;,
    &quot;dialplan&quot;:{
       &quot;context&quot;:&quot;default&quot;,
       &quot;exten&quot;:&quot;1000&quot;,
       &quot;priority&quot;:3},
    &quot;creationtime&quot;:&quot;2014-05-20T13:15:26.628-0500&quot;}
}
</code></pre><ol start="3">
<li><p>使用curl去实现Asterisk播放hello-world.注意通道的id必须与StasisStart事件中的id相匹配.</p>
<p>   curl -v -u asterisk:asterisk -X POST    “<a href="http://localhost:8088/ari/channels/1400609726.3/play?media=sound:hello-world&quot;" target="_blank" rel="noopener">http://localhost:8088/ari/channels/1400609726.3/play?media=sound:hello-world&quot;</a></p>
<p>这个Http请求的响应告诉我们请求是否成功.返回这个操作创建的JSON格式的播放资源。</p>
<ul>
<li>About to connect() to localhost port 8088 (#0)</li>
<li>Trying 127.0.0.1… connected</li>
<li>Server auth using Basic with user ‘asterisk’<blockquote>
<p>POST /ari/channels/1400609726.3/play?media=sound:hello-world HTTP/1.1<br>Authorization: Basic YXN0ZXJpc2s6c2VjcmV0<br>User-Agent: curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3<br>Host: localhost:8088<br>Accept: <em>/</em></p>
</blockquote>
&lt; HTTP/1.1 201 Created<br>&lt; Server: Asterisk/SVN-branch-12-r414137M<br>&lt; Date: Tue, 20 May 2014 18:25:15 GMT<br>&lt; Connection: close<br>&lt; Cache-Control: no-cache, no-store<br>&lt; Content-Length: 146<br>&lt; Location: /playback/9567ea46-440f-41be-a044-6ecc8100730a<br>&lt; Content-type: application/json<br>&lt;</li>
<li>Closing connection #0<br>{“id”:”9567ea46-440f-41be-a044-6ecc8100730a”,<br>“media_uri”:”sound:hello-world”,<br>“target_uri”:”channel:1400609726.3”,<br>“language”:”en”,<br>“state”:”queued”}</li>
</ul>
<p>在Asterisk中，这个声音文件会在通道中播放.</p>
<p>   – &lt;PJSIP/1000-00000001&gt; Playing ‘hello-world.gsm’ (language ‘en’)</p>
<p>在基于WebSocket的连接的wscat中，当播放开始或结束都会被通知。</p>
</li>
</ol>
<pre><code>{&quot;application&quot;:&quot;hello-world&quot;,
   &quot;type&quot;:&quot;PlaybackStarted&quot;,
   &quot;playback&quot;:{
      &quot;id&quot;:&quot;9567ea46-440f-41be-a044-6ecc8100730a&quot;,
      &quot;media_uri&quot;:&quot;sound:hello-world&quot;,
      &quot;target_uri&quot;:&quot;channel:1400609726.3&quot;,
      &quot;language&quot;:&quot;en&quot;,
      &quot;state&quot;:&quot;playing&quot;}
}

{&quot;application&quot;:&quot;hello-world&quot;,
   &quot;type&quot;:&quot;PlaybackFinished&quot;,
   &quot;playback&quot;:{
      &quot;id&quot;:&quot;9567ea46-440f-41be-a044-6ecc8100730a&quot;,
      &quot;media_uri&quot;:&quot;sound:hello-world&quot;,
      &quot;target_uri&quot;:&quot;channel:1400609726.3&quot;,
      &quot;language&quot;:&quot;en&quot;,
      &quot;state&quot;:&quot;done&quot;}
}
</code></pre><ol start="4">
<li><p>挂断电话，会导致在Asterisk中的通道被挂断，通道也会被Stasis应用释放并通过StasisEnd事件通知客户端。</p>
<p>   {“application”:”hello-world”,</p>
<pre><code>&quot;type&quot;:&quot;StasisEnd&quot;,
&quot;timestamp&quot;:&quot;2014-05-20T13:30:01.852-0500&quot;,
&quot;channel&quot;:{
   &quot;id&quot;:&quot;1400609726.3&quot;,
   &quot;state&quot;:&quot;Up&quot;,
   &quot;name&quot;:&quot;PJSIP/1000-00000001&quot;,
   &quot;caller&quot;:{
      &quot;name&quot;:&quot;&quot;,
      &quot;number&quot;:&quot;&quot;},
   &quot;connected&quot;:{
      &quot;name&quot;:&quot;&quot;,
      &quot;number&quot;:&quot;&quot;},
   &quot;accountcode&quot;:&quot;&quot;,
   &quot;dialplan&quot;:{
      &quot;context&quot;:&quot;default&quot;,
      &quot;exten&quot;:&quot;1000&quot;,
      &quot;priority&quot;:3},
   &quot;creationtime&quot;:&quot;2014-05-20T13:15:26.628-0500&quot;}
</code></pre><p>   }</p>
</li>
</ol>
<p>##相关链接</p>
<ul>
<li><a href="https://wiki.asterisk.org/wiki/display/AST/Asterisk+13+ARI" target="_blank" rel="noopener">Asterisk+13+ARI</a></li>
<li><a href="https://wiki.asterisk.org/wiki/display/AST/Asterisk+12+ARI" target="_blank" rel="noopener">Asterisk+12+ARI</a></li>
</ul>

        </section>
    </article>
    
        
  </div>
  <aside>
    
    <div class="toc-container">
        <h1>目录</h1>
        <div class="content">
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hello-World"><span class="toc-number">1.</span> <span class="toc-text">Hello World!</span></a></li></ol>
        </div>
    </div>
    
  </aside>
</main>



  <footer>
  <div class="copyright">
    <div>
      &copy; 2020 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a>&nbsp
    </div>
    <div>
      Theme by <a href="https://github.com/tqcenglish/hexo-theme-clean" target="_blank">clean</a>
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="/lib/jquery.fancybox.min.js"></script>


</body>
</html>
